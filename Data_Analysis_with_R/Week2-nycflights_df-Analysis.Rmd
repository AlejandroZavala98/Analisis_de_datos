---
title: "Week2-nycflights_df-Analysis"
author: "Alejandro Zavala"
output:
  html_document:
    theme: cerulean
    toc: true
    df_print: paged
editor_options: 
  chunk_output_type: console
---

# Análisis a los datos de vuelos que salieron de Nueva York en el año 2013

```{r setup, include=FALSE}
# Clear environment
rm(list = ls())
```

```{r load-packages, message=FALSE, include=FALSE}
library(statsr)
library(dplyr)
library(ggplot2)
library(gridExtra)
```

Se hara un analisis al dataframe "nycflights". Contiene los datos de en tiempo para una muestra aleatoria de vuelos que salieron de Nueva York. Podemos encontrar información acerca de sus variables usando el comando **?nycflights**

## Describiendo las variables del dataframe

Veamos los primeros registros de este dataframe

```{r}
head(nycflights)
```

Podemos examinar la distribución de los retrasos en las salidas de todos los vuelos con un histograma.

```{r, warning=FALSE, fig.width=14, fig.height=12}
ggplot(data = nycflights, aes(x = dep_delay)) + 
  geom_histogram(color="black", fill="darkcyan") + 
  ggtitle(label="Retrasos de salidas") +
  xlab("Tiempo de retraso") +
  ylab("Cantidad de retrasos") +
  theme_grey(base_size = 19)
```

Los histogramas son una buena manera de ver la distribución de los datos, en R se puede cambiar dependiendo de cómo se dividen los datos entre los diferentes contenedores (bins). Puede definir fácilmente el ancho del contenedor que desea utilizar (por ejemplo 15 y 150):

```{r, fig.width=14, fig.height=12}
h_1 <- ggplot(data = nycflights, aes(x = dep_delay)) +
  geom_histogram(binwidth = 15) +
  ggtitle(label="Retrasos de salidas (bin = 15)") +
  xlab("Tiempo de retraso") +
  ylab("Cantidad de retrasos") +
  theme_grey(base_size = 17)

h_2 <- ggplot(data = nycflights, aes(x = dep_delay)) +
  geom_histogram(binwidth = 150) +
  ggtitle(label="Retrasos de salidas (bin = 150)") +
  xlab("Tiempo de retraso") +
  ylab("Cantidad de retrasos") +
  theme_grey(base_size = 17)

grid.arrange(h_1, h_2,ncol = 1) # Multiple plots in one
```

## Filtrando información

Si queremos centrarnos únicamente en los retrasos en las salidas de los vuelos con destino a RDU, debemos primero filtrar los datos de los vuelos dirigidos a RDU (dest == "RDU") y despues haremos un histograma de retrasos en las salidas únicamente de esos vuelos.
Usaremos la libreria "dplyr" para hacer filtrados de la información

```{r,fig.width=14, fig.height=12}
rdu_flights <- nycflights %>% filter(dest == "RDU")
ggplot(data = rdu_flights, aes(x = dep_delay)) +
  geom_histogram(color="black", fill="darkred") +
  ggtitle(label="Retrasos de salidas con destino a RDU") +
  xlab("Tiempo de retraso") +
  ylab("Cantidad de retrasos") +
  theme_grey(base_size = 19)
```

## Obteniendo medidas por agrupaciones

Obteniendo ahora una tabla de resumen con la media, desviación estandar y numero de datos de este dataframe

De manera manual

```{r}
data.frame(mean = c(mean(rdu_flights$dep_delay)),
           sd = c(sd(rdu_flights$dep_delay)),
           length = c(length(rdu_flights$dep_delay)))
```

O tambien pudiendo ocupar la libreria **dplyr**

```{r }
rdu_flights %>%
  summarise(mean_dd = mean(dep_delay), sd_dd = sd(dep_delay), n = n())
```

Ahora tambien podemos obtener medidas por agrupaciones, para los vuelos a RDU viendo grupos por origen y obteniendo su media, desviación estandar y el numero de datos

```{r}
rdu_flights %>%
  group_by(origin) %>%
  summarise(mean_dd = mean(dep_delay), sd_dd = sd(dep_delay), n = n())
```

Ahora si queremos obtener los retrasos de vuelos con destino a SFO (San Francisco) en el mes de febrero. Recordando que el tiempo negativo representa salidas o llegadas anticipadas.

```{r, fig.width=14, fig.height=12}
sfo_feb_flights <- nycflights %>%
  filter(dest == "SFO", month == 2)

sfo_feb_flights %>%
  summarise(mean_dd = mean(dep_delay), sd_dd = sd(dep_delay), n = n())

ggplot(data = sfo_feb_flights, aes(x = dep_delay)) +
  geom_histogram(color="black", fill="darkorange") +
  ggtitle(label="Retrasos de salidas con destino a SFO en Febrero") +
  xlab("Tiempo de retraso") +
  ylab("Cantidad de retrasos") +
  theme_grey(base_size = 19)
```

Calculemos ahora la mediana y el rango intercuartil para los vuelos de llegada en el dataframe, agrupado por transportista.

```{r}
sfo_feb_flights %>%
  group_by(carrier) %>%
  summarise(median_ad = median(arr_delay),
            iqr_ad = IQR(arr_delay),
            percent25 = quantile(arr_delay, probs = 0.25),
            percent75 = quantile(arr_delay, probs = 0.75),
            n_flights = n()
            )
```

## Análisis de interes

¿En qué mes esperaría usted tener el mayor retraso promedio en la salida desde un aeropuerto de Nueva York?

```{r}
nycflights %>%
  group_by(month) %>%
  summarise(mean_dd = mean(dep_delay)) %>%
  arrange(desc(mean_dd))
```

¿Qué mes tiene el mayor retraso medio en las salidas desde un aeropuerto de Nueva York?

```{r}
nycflights %>%
  group_by(month) %>%
  summarise(median_dd = median(dep_delay)) %>%
  arrange(desc(median_dd))
```

Veamos los diagramas de caja por mes

```{r fig.width=14, fig.height=12}
ggplot(nycflights, aes(x = factor(month), y = dep_delay)) +
  geom_boxplot() +
  theme_grey(base_size = 17)
```

Crearemos un nuevo dataframe el cual tendra una columna nueva donde el tiempo de retraso si es menor a 5 minutos sera en tiempo (on time) y si es mayor lo marcaremos como retraso (delayed)

```{r dep-type}
nycflights_on_d <- nycflights %>%
  mutate(dep_type = ifelse(dep_delay < 5, "on time", "delayed"))
```

Veamos la nueva variable que agrego

```{r}
head(nycflights_on_d)
```

Haremos un agrupado por origen y tomando la proporción si es un viaje en tiempo o anticipado comparandolo con algun retardo

```{r}
nycflights_on_d %>%
  group_by(origin) %>%
  summarise(ot_dep_rate = sum(dep_type == "on time") / n() , dl_dep_rate = sum(dep_type != "on time") / n()) %>%
  arrange(desc(ot_dep_rate))
```

También podemos visualizar la distribución de la tasa de salidas puntuales en los tres aeropuertos utilizando un gráfico de barras segmentadas.

```{r, fig.width=14, fig.height=12}
ggplot(data = nycflights_on_d, aes(x = origin, fill = dep_type)) +
  geom_bar() + theme_grey(base_size = 19)
```

Ahora, si no le queremos los retrasos en la salida y deseamos programar un viaje en un mes que minimice el posible retraso en la salida al salir de Nueva York. Una alternativa podria ser elegir el mes con el menor retraso medio en la salida. Otra opción es elegir el mes con el retraso de mediana de salida más bajo. ¿Cuáles son los pros y los contras de estas dos opciones?

Media: representa el promedio general, teniendo en cuenta el efecto de cada retraso y dando una idea de cómo se distribuyen los datos. Desventaja: esto puede verse sesgado por valores atípicos.

Mediana: toma el valor medio de todo el conjunto de datos, por lo que los valores atípicos no sesgan la mediana. Desventaja: no representa cómo se distribuyen los datos.

Ahora, crearemos una variable llamada velocidad promedio, se puede calcular como la distancia dividida por el número de horas de viaje, y tenga en cuenta que el tiempo_aire se expresa en minutos. Una vez aplicando ese filtro y ademas ordenando descendentemente veremos los vuelos con la velocidad mas alta.

```{r}
nycflights_sp <- nycflights %>%
  mutate(avg_speed = 60*(distance / air_time)) %>%
  arrange(desc(avg_speed))

head(nycflights_sp)
```

Ahora, haciendo un gráfico de dispersión entre la distancia y velocidad, se obtiene:

```{r, fig.width=14, fig.height=12}
ggplot(data = nycflights_sp, aes(x = distance, y = avg_speed)) + 
  geom_point() +
  ggtitle(label="Velocidad promedio de vuelos de NY") +
  xlab("Distancia") +
  ylab("Velocidad promedio") +
  theme_grey(base_size = 19)
```
